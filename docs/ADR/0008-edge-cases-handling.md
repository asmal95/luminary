# ADR-0008: Обработка крайних случаев

## Статус
Принято

## Контекст
Необходимо определить поведение системы в крайних случаях: бинарные файлы, большие MR, ошибки API.

## Решение

### Бинарные файлы:
- Автоматическое определение бинарных файлов (попытка декодирования как UTF-8)
- Пропуск бинарных файлов с логированием

### Игнорирование по паттернам:
- Настраиваемый список паттернов в конфиге
- Дефолтные паттерны:
  - `*.lock` (package-lock.json, yarn.lock, poetry.lock, etc.)
  - `*.min.js`, `*.min.css`
  - `*.map` (source maps)
  - `node_modules/**`, `.git/**`
- Поддержка glob паттернов

### Лимиты на размер MR:
- Настраиваемые лимиты:
  - `max_files`: максимальное количество файлов
  - `max_lines`: максимальное количество измененных строк
- По умолчанию: без лимитов (обрабатываем все)
- При превышении: частичный анализ (обрабатываем первые N файлов, логируем предупреждение)

### Retry стратегия:
- Экспоненциальный backoff
- Формула: `delay = initial_delay * (backoff_multiplier ^ attempt)`
- Максимум 3 попытки
- Применяется для:
  - Ошибок LLM API (rate limit, временные сбои)
  - Ошибок GitLab API (rate limit, временные сбои)
- Не применяется для:
  - Ошибок аутентификации (401)
  - Ошибок авторизации (403)
  - Ошибок валидации (400)

### Логирование:
- Все пропущенные файлы логируются с причиной
- Все ошибки логируются с контекстом
- Статистика обработки (успешно, пропущено, ошибки)

## Последствия

### Положительные:
- Устойчивость к ошибкам
- Понятное поведение в крайних случаях
- Данные для анализа и улучшения

### Отрицательные:
- Частичный анализ может пропустить важные проблемы
- Retry увеличивает время выполнения при ошибках
